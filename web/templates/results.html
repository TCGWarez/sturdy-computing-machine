<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Batch Results - MTG Scanner Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0071e3",
                        "primary-hover": "#0077ed",
                        "bg-page": "#f5f5f7",
                        "surface": "#ffffff",
                        "surface-alt": "#fbfbfd",
                        "border-subtle": "#d1d1d6",
                        "border-light": "#e5e5ea",
                        "text-main": "#1d1d1f",
                        "text-secondary": "#86868b",
                        "success": "#34c759",
                        "danger": "#ff3b30",
                        "warning": "#ff9f0a",
                        "foil-gold": "#d4af37",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "sans": ["Inter", "-apple-system", "BlinkMacSystemFont", "Segoe UI", "Roboto", "Helvetica", "Arial", "sans-serif"],
                    },
                    borderRadius: {"DEFAULT": "0.5rem", "lg": "0.75rem", "xl": "1rem", "2xl": "1.25rem", "3xl": "1.5rem", "full": "9999px"},
                    boxShadow: {
                        "soft": "0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02)",
                        "card": "0 4px 20px rgba(0, 0, 0, 0.03)",
                        "glow": "0 0 20px rgba(0, 113, 227, 0.15)",
                    }
                },
            },
        }
    </script>
    <style>
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d1d6; border-radius: 5px; border: 2px solid #f5f5f7; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a6; }

        /* Toggle switch */
        .toggle-checkbox:checked { right: 0; border-color: #0071e3; }
        .toggle-checkbox:checked + .toggle-label { background-color: #0071e3; }
        .toggle-checkbox:disabled + .toggle-label { background-color: #e5e5ea; cursor: not-allowed; opacity: 0.5; }
        .toggle-checkbox:disabled { cursor: not-allowed; }

        /* Foil badge shimmer effect */
        .foil-badge {
            background: linear-gradient(135deg, #d4af37 0%, #f4e5b2 50%, #d4af37 100%);
            background-size: 200% 200%;
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Card hover effect */
        .card-result:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.08); }

        /* Image lightbox */
        .image-lightbox {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; cursor: zoom-out;
        }
        .image-lightbox img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 32px; cursor: pointer; }
    </style>
</head>
<body class="bg-bg-page text-text-main h-screen flex flex-col overflow-hidden antialiased selection:bg-primary/10 selection:text-primary">
    <!-- Header -->
    <header class="flex items-center justify-between whitespace-nowrap border-b border-border-light bg-surface/80 backdrop-blur-xl px-6 py-3 shrink-0 z-30 sticky top-0">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2.5">
                <div class="size-8 text-primary flex items-center justify-center bg-primary/10 rounded-lg">
                    <span class="material-symbols-outlined text-2xl">view_in_ar</span>
                </div>
                <h2 class="text-text-main text-lg font-bold font-display tracking-tight">MTG Scanner Pro</h2>
            </div>
            <div class="h-6 w-px bg-border-light mx-2 hidden md:block"></div>
            <nav class="hidden md:flex items-center gap-1">
                <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-primary bg-primary/5 transition-all" href="#">Review Queue</a>
                <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-text-secondary hover:text-text-main hover:bg-gray-100 transition-all" href="#">Batches</a>
                <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-text-secondary hover:text-text-main hover:bg-gray-100 transition-all" href="/">Upload Scans</a>
                <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-text-secondary hover:text-text-main hover:bg-gray-100 transition-all" href="#">Settings</a>
            </nav>
        </div>
        <div class="flex items-center gap-3">
            <!-- Export Dropdown -->
            <div class="relative" id="exportDropdown">
                <button onclick="toggleExportMenu()" class="px-4 py-1.5 text-sm font-medium text-text-secondary hover:text-text-main hover:bg-gray-100 rounded-lg transition-all flex items-center gap-1.5">
                    <span class="material-symbols-outlined text-lg">download</span> Export
                    <span class="material-symbols-outlined text-base">expand_more</span>
                </button>
                <div id="exportMenu" class="hidden absolute right-0 top-full mt-1 bg-white border border-border-light rounded-lg shadow-lg py-1 min-w-[160px] z-50">
                    <button onclick="exportResults('csv')" class="w-full px-4 py-2 text-left text-sm text-text-main hover:bg-gray-50 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg text-text-secondary">table_view</span> CSV
                    </button>
                    <button onclick="exportResults('json')" class="w-full px-4 py-2 text-left text-sm text-text-main hover:bg-gray-50 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg text-text-secondary">data_object</span> JSON
                    </button>
                    <hr class="my-1 border-border-light">
                    <button onclick="exportResults('manapool_csv')" class="w-full px-4 py-2 text-left text-sm text-text-main hover:bg-gray-50 flex items-center gap-2">
                        <span class="material-symbols-outlined text-lg text-text-secondary">water_drop</span> Manapool CSV
                    </button>
                </div>
            </div>
            <div class="size-9 bg-gradient-to-br from-primary to-blue-600 rounded-full border border-border-light shadow-sm flex items-center justify-center text-white font-semibold text-sm">U</div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative">
        <main class="flex-1 flex flex-col relative overflow-y-auto">
            <div class="p-6 lg:p-8 max-w-7xl mx-auto w-full space-y-6">
                <!-- Page Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 class="text-2xl font-semibold text-text-main mb-1 tracking-tight">Review Queue</h1>
                        <p class="text-text-secondary text-sm">Validate incoming card scans for the recognition engine.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <a href="/" class="px-4 py-2 text-sm font-medium text-text-secondary hover:text-text-main bg-white border border-border-light rounded-lg shadow-sm hover:shadow transition-all">
                            New Batch
                        </a>
                        <button id="reviewModeBtn" onclick="enterReviewMode()" class="px-5 py-2 bg-primary hover:bg-primary-hover text-white text-sm font-semibold rounded-lg shadow-lg shadow-blue-500/20 transition-all flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">play_arrow</span> Start Session
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-surface border border-border-light rounded-xl p-4 shadow-soft">
                        <div class="text-2xl font-bold text-text-main" id="totalCards">0</div>
                        <div class="text-xs text-text-secondary font-medium uppercase tracking-wide">Total</div>
                    </div>
                    <div class="bg-surface border border-success/20 rounded-xl p-4 shadow-soft">
                        <div class="text-2xl font-bold text-success" id="highConfidence">0</div>
                        <div class="text-xs text-text-secondary font-medium uppercase tracking-wide">High (90%+)</div>
                    </div>
                    <div class="bg-surface border border-warning/20 rounded-xl p-4 shadow-soft">
                        <div class="text-2xl font-bold text-warning" id="mediumConfidence">0</div>
                        <div class="text-xs text-text-secondary font-medium uppercase tracking-wide">Medium</div>
                    </div>
                    <div class="bg-surface border border-danger/20 rounded-xl p-4 shadow-soft">
                        <div class="text-2xl font-bold text-danger" id="lowConfidence">0</div>
                        <div class="text-xs text-text-secondary font-medium uppercase tracking-wide">Low (&lt;70%)</div>
                    </div>
                    <div class="bg-surface border border-border-light rounded-xl p-4 shadow-soft">
                        <div class="text-2xl font-bold text-text-main" id="ambiguousCount">0</div>
                        <div class="text-xs text-text-secondary font-medium uppercase tracking-wide">Ambiguous</div>
                    </div>
                </div>

                <!-- Grid View -->
                <div id="resultsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                    <!-- Cards populated by JS -->
                </div>

                <!-- Review Mode (hidden by default) -->
                <div id="reviewMode" class="fixed inset-0 bg-bg-page z-50 flex" style="display: none;">
                    <!-- Left: Image Comparison -->
                    <div class="flex-1 flex items-center justify-center p-8 bg-[#f2f2f7]">
                        <div class="relative flex items-center gap-8">
                            <!-- Scanned Image -->
                            <div class="relative group cursor-pointer" onclick="openLightbox(document.getElementById('reviewScannedImg').src)">
                                <img id="reviewScannedImg" src="" alt="Scanned" class="h-[500px] w-auto rounded-xl shadow-2xl ring-1 ring-black/5 object-contain bg-white"/>
                                <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-white px-3 py-1 rounded-full text-xs font-bold text-text-secondary shadow-md border border-border-light">SCAN</div>
                            </div>
                            <!-- VS Badge -->
                            <div class="size-12 bg-white rounded-full shadow-lg flex items-center justify-center text-text-secondary font-bold text-sm border border-border-light">VS</div>
                            <!-- Reference Image -->
                            <div class="relative group cursor-pointer" onclick="openLightbox(document.getElementById('reviewReferenceImg').src)">
                                <img id="reviewReferenceImg" src="" alt="Match" class="h-[500px] w-auto rounded-xl shadow-2xl ring-1 ring-black/5 object-contain bg-white"/>
                                <div class="absolute -bottom-3 left-1/2 -translate-x-1/2 bg-primary px-3 py-1 rounded-full text-xs font-bold text-white shadow-md">MATCH</div>
                            </div>
                        </div>
                        <!-- Navigation -->
                        <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4 bg-white/80 backdrop-blur-md px-4 py-2 rounded-full shadow-lg border border-white/40">
                            <button onclick="prevCard()" id="prevBtn" class="size-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-text-secondary disabled:opacity-30 transition-all">
                                <span class="material-symbols-outlined">arrow_back</span>
                            </button>
                            <span id="reviewProgress" class="text-sm font-medium text-text-main px-4">Card 1 of 47</span>
                            <button onclick="nextCard()" id="nextBtn" class="size-10 flex items-center justify-center rounded-full hover:bg-gray-100 text-text-secondary disabled:opacity-30 transition-all">
                                <span class="material-symbols-outlined">arrow_forward</span>
                            </button>
                        </div>
                    </div>

                    <!-- Right: Details Panel -->
                    <aside class="w-[420px] bg-surface border-l border-border-light flex flex-col shadow-xl">
                        <!-- Header -->
                        <div class="px-6 py-5 border-b border-border-light flex justify-between items-center">
                            <h3 class="text-text-main text-lg font-semibold">Recognition Result</h3>
                            <button onclick="exitReviewMode()" class="size-8 flex items-center justify-center rounded-full hover:bg-gray-100 text-text-secondary transition-colors">
                                <span class="material-symbols-outlined">close</span>
                            </button>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 overflow-y-auto p-6 space-y-6">
                            <!-- Confidence -->
                            <div class="space-y-2">
                                <div class="flex justify-between items-end">
                                    <label class="text-text-secondary text-xs font-semibold uppercase tracking-wider">Confidence</label>
                                    <span id="reviewConfidenceValue" class="text-success text-sm font-bold flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">check_circle</span> 98.5%
                                    </span>
                                </div>
                                <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                    <div id="reviewConfidenceFill" class="h-full bg-gradient-to-r from-primary to-success rounded-full transition-all" style="width: 98.5%"></div>
                                </div>
                            </div>

                            <!-- Card Info -->
                            <div class="space-y-1">
                                <h2 id="reviewCardName" class="text-2xl font-bold text-text-main leading-tight">Card Name</h2>
                                <p id="reviewCardMeta" class="text-text-secondary text-sm">SET #000 - nonfoil</p>
                            </div>

                            <!-- Badges -->
                            <div class="flex flex-wrap gap-2">
                                <div id="ambiguousBadge" class="px-3 py-1.5 bg-warning/10 text-warning border border-warning/20 rounded-lg text-xs font-semibold flex items-center gap-1.5" style="display: none;">
                                    <span class="material-symbols-outlined text-sm">warning</span>
                                    <span id="ambiguousCountBadge">3</span> similar cards
                                </div>
                                <div id="correctedBadge" class="px-3 py-1.5 bg-success/10 text-success border border-success/20 rounded-lg text-xs font-semibold flex items-center gap-1.5" style="display: none;">
                                    <span class="material-symbols-outlined text-sm">check_circle</span> Corrected
                                </div>
                            </div>

                            <!-- Foil Toggle -->
                            <div class="pt-4 border-t border-border-light space-y-3">
                                <label class="text-xs font-semibold text-text-secondary uppercase tracking-wider">Card Properties</label>
                                <div class="flex flex-wrap gap-6">
                                    <label id="foilToggleWrapper" class="flex items-center gap-3 cursor-pointer group relative">
                                        <div class="relative inline-block w-11 h-6 align-middle select-none">
                                            <input id="foilToggle" type="checkbox" onchange="toggleFoil()" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border border-border-light shadow-sm appearance-none cursor-pointer translate-x-0.5 top-0.5 checked:translate-x-[22px] transition-transform duration-200 z-10"/>
                                            <div class="toggle-label block h-6 rounded-full bg-gray-200 cursor-pointer transition-colors"></div>
                                        </div>
                                        <span class="text-text-main text-sm font-medium">Foil</span>
                                        <!-- Tooltip for disabled state -->
                                        <div id="foilTooltip" class="absolute bottom-full left-0 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap opacity-0 pointer-events-none transition-opacity">
                                            No foil variant available
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Search for correction -->
                            <div class="space-y-3">
                                <label class="text-xs font-semibold text-text-secondary uppercase tracking-wider">Search Correction</label>
                                <div class="relative">
                                    <input type="text" id="inlineSearchInput" placeholder="Search for correct card..."
                                           class="w-full bg-surface-alt border border-border-subtle/60 rounded-lg px-4 py-3 pr-10 text-text-main text-sm focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all placeholder:text-text-secondary/50"/>
                                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary">search</span>
                                </div>
                                <select id="inlineSetFilter" class="w-full bg-surface-alt border border-border-subtle/60 rounded-lg px-4 py-2.5 text-text-main text-sm focus:outline-none focus:border-primary transition-all">
                                    <option value="">All Sets</option>
                                </select>
                            </div>

                            <!-- Candidates -->
                            <div class="space-y-3">
                                <label class="text-xs font-semibold text-text-secondary uppercase tracking-wider">Alternative Matches</label>
                                <div id="candidateGrid" class="grid grid-cols-3 gap-2">
                                    <!-- Candidates populated by JS -->
                                </div>
                                <div id="inlineSearchResults" class="grid grid-cols-3 gap-2" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div class="p-6 border-t border-border-light bg-gray-50 space-y-3">
                            <div class="flex gap-3">
                                <button onclick="acceptAndNext()" id="acceptBtn" class="flex-1 h-12 bg-text-main hover:bg-black text-white font-semibold rounded-xl shadow-sm flex items-center justify-center gap-2 transition-all transform active:scale-[0.98]">
                                    <span class="material-symbols-outlined text-lg">check_circle</span> Confirm & Next
                                </button>
                                <button onclick="nextCard()" class="size-12 bg-white hover:bg-gray-50 text-text-secondary rounded-xl flex items-center justify-center border border-border-light shadow-sm transition-all" title="Skip">
                                    <span class="material-symbols-outlined">skip_next</span>
                                </button>
                            </div>
                            <div class="text-center text-xs text-text-secondary">
                                <kbd class="px-1.5 py-0.5 bg-white border border-border-light rounded text-[10px] font-mono">←</kbd>
                                <kbd class="px-1.5 py-0.5 bg-white border border-border-light rounded text-[10px] font-mono">→</kbd> navigate
                                <span class="mx-2">|</span>
                                <kbd class="px-1.5 py-0.5 bg-white border border-border-light rounded text-[10px] font-mono">Enter</kbd> accept
                                <span class="mx-2">|</span>
                                <kbd class="px-1.5 py-0.5 bg-white border border-border-light rounded text-[10px] font-mono">Esc</kbd> exit
                            </div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <script>
        const batchId = window.location.pathname.split('/').pop();
        let batchResults = [];
        let currentImageId = null;
        let selectedCardId = null;

        // MTGSold toggle from backend
        const mtgsoldEnabled = {{ 'true' if mtgsold_enabled else 'false' }};

        // Load results and sets on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadResults();
            loadSetFilters();
        });

        async function loadSetFilters() {
            try {
                const response = await fetch('/api/batch/sets');
                const sets = await response.json();
                const inlineSelect = document.getElementById('inlineSetFilter');
                sets.forEach(setCode => {
                    const option = document.createElement('option');
                    option.value = setCode;
                    option.textContent = setCode.toUpperCase();
                    inlineSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading sets:', error);
            }
        }

        async function loadResults() {
            try {
                const response = await fetch(`/api/batch/${batchId}/results`);
                const data = await response.json();
                batchResults = data.results;
                updateStats(data.results);
                renderResults(data.results);
            } catch (error) {
                console.error('Error loading results:', error);
                alert('Failed to load results');
            }
        }

        function updateStats(results) {
            const total = results.length;
            const high = results.filter(r => r.confidence >= 0.9).length;
            const medium = results.filter(r => r.confidence >= 0.7 && r.confidence < 0.9).length;
            const low = results.filter(r => r.confidence < 0.7).length;
            const ambiguous = results.filter(r => r.is_ambiguous).length;

            document.getElementById('totalCards').textContent = total;
            document.getElementById('highConfidence').textContent = high;
            document.getElementById('mediumConfidence').textContent = medium;
            document.getElementById('lowConfidence').textContent = low;
            document.getElementById('ambiguousCount').textContent = ambiguous;
        }

        function renderResults(results) {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            results.forEach(result => {
                const card = createCardElement(result);
                grid.appendChild(card);
            });
        }

        function createCardElement(result) {
            const card = document.createElement('div');
            card.className = 'card-result bg-surface border border-border-light rounded-xl overflow-hidden shadow-soft hover:shadow-card transition-all cursor-pointer';
            card.onclick = () => openReviewAt(result.image_id);

            const confidencePercent = (result.confidence * 100).toFixed(0);
            const confidenceColor = result.confidence >= 0.9 ? 'text-success bg-success/10' :
                                   result.confidence >= 0.7 ? 'text-warning bg-warning/10' : 'text-danger bg-danger/10';

            // Finish badge (show actual finish)
            let finishBadge = '';
            if (result.finish === 'foil') {
                finishBadge = `<span class="foil-badge px-2 py-0.5 rounded text-[10px] font-bold text-amber-900">Foil</span>`;
            }

            card.innerHTML = `
                <div class="aspect-[5/7] bg-gray-100 relative overflow-hidden">
                    <img src="${result.image_url}" alt="${result.image_filename}" class="w-full h-full object-cover"/>
                    <div class="absolute top-2 right-2 ${confidenceColor} px-2 py-1 rounded-lg text-xs font-bold backdrop-blur-sm">
                        ${confidencePercent}%
                    </div>
                    ${result.is_ambiguous ? '<div class="absolute top-2 left-2 bg-warning/90 text-white px-2 py-1 rounded-lg text-[10px] font-bold">Ambiguous</div>' : ''}
                    ${result.is_corrected ? '<div class="absolute bottom-2 left-2 bg-success/90 text-white px-2 py-0.5 rounded text-[10px] font-bold">Corrected</div>' : ''}
                </div>
                <div class="p-3 space-y-2">
                    <h3 class="font-semibold text-text-main text-sm truncate" title="${result.card_name}">${result.card_name}</h3>
                    <p class="text-text-secondary text-xs">${result.set_code} #${result.collector_number}</p>
                    <div class="flex flex-wrap gap-1.5">
                        ${finishBadge}
                    </div>
                </div>
            `;
            return card;
        }

        // ============================================
        // REVIEW MODE
        // ============================================
        let isReviewMode = false;
        let currentReviewIndex = 0;
        let filteredResults = [];

        function enterReviewMode() {
            if (batchResults.length === 0) {
                alert('No results to review');
                return;
            }
            isReviewMode = true;
            filteredResults = [...batchResults];
            currentReviewIndex = 0;

            document.getElementById('reviewMode').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            renderCurrentReviewCard();
            document.addEventListener('keydown', handleReviewKeyboard);
        }

        function openReviewAt(imageId) {
            const index = batchResults.findIndex(r => r.image_id === imageId);
            if (index >= 0) {
                isReviewMode = true;
                filteredResults = [...batchResults];
                currentReviewIndex = index;
                document.getElementById('reviewMode').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                renderCurrentReviewCard();
                document.addEventListener('keydown', handleReviewKeyboard);
            }
        }

        function exitReviewMode() {
            isReviewMode = false;
            document.getElementById('reviewMode').style.display = 'none';
            document.body.style.overflow = '';
            document.removeEventListener('keydown', handleReviewKeyboard);
        }

        function renderCurrentReviewCard() {
            if (filteredResults.length === 0) return;
            const result = filteredResults[currentReviewIndex];

            // Progress
            document.getElementById('reviewProgress').textContent = `Card ${currentReviewIndex + 1} of ${filteredResults.length}`;

            // Images
            document.getElementById('reviewScannedImg').src = result.image_url;
            document.getElementById('reviewReferenceImg').src = result.reference_image_url || '';

            // Card info
            document.getElementById('reviewCardName').textContent = result.card_name;
            document.getElementById('reviewCardMeta').textContent = `${result.set_code} #${result.collector_number} - ${result.finish}`;

            // Confidence
            const confidence = result.confidence;
            const confidencePercent = (confidence * 100).toFixed(0);
            const fill = document.getElementById('reviewConfidenceFill');
            const valueEl = document.getElementById('reviewConfidenceValue');

            fill.style.width = `${confidence * 100}%`;
            valueEl.innerHTML = confidence >= 0.9
                ? `<span class="material-symbols-outlined text-sm">check_circle</span> ${confidencePercent}%`
                : `${confidencePercent}%`;
            valueEl.className = confidence >= 0.9 ? 'text-success text-sm font-bold flex items-center gap-1' :
                               confidence >= 0.7 ? 'text-warning text-sm font-bold flex items-center gap-1' :
                               'text-danger text-sm font-bold flex items-center gap-1';

            // Foil toggle (allows switching between foil/nonfoil variants)
            const foilToggle = document.getElementById('foilToggle');
            const foilWrapper = document.getElementById('foilToggleWrapper');
            const foilTooltip = document.getElementById('foilTooltip');

            foilToggle.checked = result.finish === 'foil';

            // Check if variant exists (we'll enable/disable based on this)
            // For now, always enable - the API will handle validation
            foilToggle.disabled = false;
            foilWrapper.classList.remove('opacity-50');
            foilTooltip.style.display = 'none';

            // Badges
            document.getElementById('ambiguousBadge').style.display = result.is_ambiguous ? 'flex' : 'none';
            if (result.is_ambiguous) {
                document.getElementById('ambiguousCountBadge').textContent = result.candidates?.length || 0;
            }
            document.getElementById('correctedBadge').style.display = result.is_corrected ? 'flex' : 'none';

            // Navigation
            document.getElementById('prevBtn').disabled = currentReviewIndex === 0;
            document.getElementById('nextBtn').disabled = currentReviewIndex >= filteredResults.length - 1;

            // Candidates
            renderCandidates(result.candidates || []);
        }

        function renderCandidates(candidates) {
            const grid = document.getElementById('candidateGrid');
            grid.innerHTML = '';

            if (candidates.length === 0) {
                grid.innerHTML = '<p class="text-text-secondary text-xs col-span-3">No alternatives</p>';
                return;
            }

            candidates.slice(0, 6).forEach((c, i) => {
                const div = document.createElement('div');
                div.className = 'relative aspect-[5/7] bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary transition-all group';
                div.innerHTML = `
                    <img src="${c.reference_image_url || ''}" alt="${c.card_name}" class="w-full h-full object-cover" onerror="this.style.display='none'"/>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    <div class="absolute bottom-1 left-1 right-1 text-white text-[9px] font-medium truncate opacity-0 group-hover:opacity-100 transition-opacity">${c.card_name}</div>
                    <kbd class="absolute top-1 right-1 px-1 py-0.5 bg-black/50 text-white text-[9px] rounded font-mono">${i + 1}</kbd>
                `;
                div.onclick = () => selectCandidate(c.card_id);
                grid.appendChild(div);
            });
        }

        function handleReviewKeyboard(e) {
            if (!isReviewMode) return;
            const searchInput = document.getElementById('inlineSearchInput');
            if (document.activeElement === searchInput) return;

            switch(e.key) {
                case 'ArrowLeft': prevCard(); e.preventDefault(); break;
                case 'ArrowRight': nextCard(); e.preventDefault(); break;
                case 'Enter': acceptAndNext(); e.preventDefault(); break;
                case 'Escape': exitReviewMode(); e.preventDefault(); break;
                case '1': case '2': case '3': case '4': case '5': case '6':
                    const idx = parseInt(e.key) - 1;
                    const candidates = filteredResults[currentReviewIndex]?.candidates || [];
                    if (candidates[idx]) selectCandidate(candidates[idx].card_id);
                    break;
            }
        }

        function prevCard() {
            if (currentReviewIndex > 0) {
                currentReviewIndex--;
                renderCurrentReviewCard();
            }
        }

        function nextCard() {
            if (currentReviewIndex < filteredResults.length - 1) {
                currentReviewIndex++;
                renderCurrentReviewCard();
            }
        }

        async function acceptAndNext() {
            const btn = document.getElementById('acceptBtn');
            btn.innerHTML = '<span class="material-symbols-outlined text-lg">check</span> Accepted!';
            btn.disabled = true;
            setTimeout(() => {
                btn.innerHTML = '<span class="material-symbols-outlined text-lg">check_circle</span> Confirm & Next';
                btn.disabled = false;
                nextCard();
            }, 300);
        }

        async function selectCandidate(cardId) {
            const result = filteredResults[currentReviewIndex];
            if (!result) return;

            const savedIndex = currentReviewIndex;
            const currentImageId = result.image_id;

            try {
                const response = await fetch(`/api/batch/${batchId}/correct`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_id: result.image_id,
                        correct_card_id: cardId,
                        reason: 'Selected from review mode'
                    })
                });

                if (!response.ok) throw new Error('Correction failed');

                await loadResults();
                filteredResults = [...batchResults];
                const newIndex = filteredResults.findIndex(r => r.image_id === currentImageId);
                currentReviewIndex = newIndex >= 0 ? newIndex : Math.min(savedIndex, filteredResults.length - 1);
                renderCurrentReviewCard();

            } catch (error) {
                console.error('Correction error:', error);
                alert('Failed to save correction');
            }
        }

        // ============================================
        // FOIL TOGGLE
        // ============================================
        async function toggleFoil() {
            const result = filteredResults[currentReviewIndex];
            if (!result) return;

            const isChecked = document.getElementById('foilToggle').checked;
            const newFinish = isChecked ? 'foil' : 'nonfoil';

            try {
                const response = await fetch(`/api/batch/${batchId}/toggle-finish`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        image_id: result.image_id,
                        new_finish: newFinish
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    // Revert toggle
                    document.getElementById('foilToggle').checked = !isChecked;

                    // Show tooltip for no variant
                    if (error.detail?.includes('No variant')) {
                        const tooltip = document.getElementById('foilTooltip');
                        tooltip.textContent = error.detail;
                        tooltip.style.opacity = '1';
                        setTimeout(() => { tooltip.style.opacity = '0'; }, 2000);
                    } else {
                        alert(error.detail || 'Failed to toggle finish');
                    }
                    return;
                }

                // Reload and refresh
                await loadResults();
                filteredResults = [...batchResults];
                renderCurrentReviewCard();

            } catch (error) {
                console.error('Toggle finish error:', error);
                document.getElementById('foilToggle').checked = !isChecked;
                alert('Failed to toggle finish');
            }
        }

        // ============================================
        // INLINE SEARCH
        // ============================================
        let inlineSearchTimeout;
        document.getElementById('inlineSearchInput')?.addEventListener('input', (e) => {
            clearTimeout(inlineSearchTimeout);
            const query = e.target.value.trim();

            if (query.length < 2) {
                document.getElementById('inlineSearchResults').style.display = 'none';
                document.getElementById('candidateGrid').style.display = 'grid';
                return;
            }

            inlineSearchTimeout = setTimeout(() => searchCardsInline(query), 300);
        });

        document.getElementById('inlineSetFilter')?.addEventListener('change', () => {
            const query = document.getElementById('inlineSearchInput').value.trim();
            if (query.length >= 2) searchCardsInline(query);
        });

        document.getElementById('inlineSearchInput')?.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.target.value = '';
                document.getElementById('inlineSearchResults').style.display = 'none';
                document.getElementById('candidateGrid').style.display = 'grid';
                e.target.blur();
                e.stopPropagation();
            }
        });

        async function searchCardsInline(query) {
            const setFilter = document.getElementById('inlineSetFilter').value;
            let url = `/api/batch/search?query=${encodeURIComponent(query)}&limit=12`;
            if (setFilter) url += `&set_code=${encodeURIComponent(setFilter)}`;

            try {
                const response = await fetch(url);
                const cards = await response.json();

                const resultsDiv = document.getElementById('inlineSearchResults');
                const candidateGrid = document.getElementById('candidateGrid');

                candidateGrid.style.display = 'none';
                resultsDiv.style.display = 'grid';
                resultsDiv.innerHTML = '';

                if (cards.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-text-secondary text-xs col-span-3">No cards found</p>';
                    return;
                }

                cards.forEach((card) => {
                    const div = document.createElement('div');
                    div.className = 'relative aspect-[5/7] bg-gray-100 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-primary transition-all group';
                    div.innerHTML = `
                        <img src="${card.scryfall_image_url || ''}" alt="${card.card_name}" class="w-full h-full object-cover" onerror="this.style.display='none'"/>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="absolute bottom-1 left-1 right-1 text-white text-[9px] font-medium truncate opacity-0 group-hover:opacity-100 transition-opacity">${card.card_name}</div>
                    `;
                    div.onclick = () => {
                        document.getElementById('inlineSearchInput').value = '';
                        document.getElementById('inlineSearchResults').style.display = 'none';
                        document.getElementById('candidateGrid').style.display = 'grid';
                        selectCandidate(card.card_id);
                    };
                    resultsDiv.appendChild(div);
                });

            } catch (error) {
                console.error('Search error:', error);
            }
        }

        // ============================================
        // EXPORT DROPDOWN
        // ============================================
        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.classList.toggle('hidden');
        }

        // Close export menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('exportDropdown');
            const menu = document.getElementById('exportMenu');
            if (dropdown && !dropdown.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        async function exportResults(format) {
            // Close the menu
            document.getElementById('exportMenu').classList.add('hidden');
            window.location.href = `/api/batch/${batchId}/export?format=${format}`;
        }

        // ============================================
        // LIGHTBOX
        // ============================================
        function openLightbox(imgSrc) {
            const lightbox = document.createElement('div');
            lightbox.className = 'image-lightbox';
            lightbox.innerHTML = `
                <span class="lightbox-close">&times;</span>
                <img src="${imgSrc}" alt="Enlarged"/>
            `;
            lightbox.onclick = closeLightbox;
            document.addEventListener('keydown', lightboxKeyHandler);
            document.body.appendChild(lightbox);
        }

        function closeLightbox() {
            const lightbox = document.querySelector('.image-lightbox');
            if (lightbox) {
                lightbox.remove();
                document.removeEventListener('keydown', lightboxKeyHandler);
            }
        }

        function lightboxKeyHandler(e) {
            if (e.key === 'Escape') closeLightbox();
        }
    </script>
</body>
</html>


